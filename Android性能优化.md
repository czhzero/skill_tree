# Android


## 应用Ui卡顿原理

人类大脑与眼睛对一个画面的连贯性感知其实是有一个界限的，譬如我们看电影会觉得画面很自然连贯（帧率为24fps），用手机当然也需要感知屏幕操作的连贯性（尤其是动画过度），所以Android索性就把达到这种流畅的帧率规定为60fps。

有了上面的背景，我们开发App的帧率性能目标就是保持在60fps，也就是说我们在进行App性能优化时心中要有如下准则：

> 换算关系：60帧/秒-----------16ms/帧；
>
> 准则：尽量保证每次在16ms内处理完所有的CPU与GPU计算、绘制、渲染等操作，否则会造成丢帧卡顿问题。
> 

从上面可以看出来，所谓的卡顿其实是可以量化的，每次是否能够成功渲染是非常重要的问题，16ms能否完整的做完一次操作直接决定了卡顿性能问题。

当然了，针对Android系统的设计我们还需要知道另一个常识；虚拟机在执行GC垃圾回收操作时所有线程（包括UI线程）都需要暂停，当GC垃圾回收完成之后所有线程才能够继续执行（这个细节下面小节会有详细介绍）。也就是说当在16ms内进行渲染等操作时如果刚好遇上大量GC操作则会导致渲染时间明显不足，也就从而导致了丢帧卡顿问题。

有了上面这两个简单的理论基础之后我们下面就会探讨一些UI卡顿的原因分析及解决方案。


## 应用UI卡顿常见原因

我们在使用App时会发现有些界面启动卡顿、动画不流畅、列表等滑动时也会卡顿，究其原因，很多都是丢帧导致的；通过上面卡顿原理的简单说明我们从应用开发的角度往回推理可以得出常见卡顿原因，如下：

- 人为在UI线程中做轻微耗时操作，导致UI线程卡顿；

- 布局Layout过于复杂，无法在16ms内完成渲染；

- 同一时间动画执行的次数过多，导致CPU或GPU负载过重；

- View过度绘制，导致某些像素在同一帧时间内被绘制多次，从而使CPU或GPU负载过重；

- View频繁的触发measure、layout，导致measure、layout累计耗时过多及整个View频繁的重新渲染；

- 内存频繁触发GC过多（同一帧中频繁创建内存），导致暂时阻塞渲染操作；

- 冗余资源及逻辑等导致加载和执行缓慢；

- 臭名昭著的ANR；


可以看见，上面这些导致卡顿的原因都是我们平时开发中非常常见的。有些人可能会觉得自己的应用用着还蛮OK的，其实那是因为你没进行一些瞬时测试和压力测试，一旦在这种环境下运行你的App你就会发现很多性能问题。

## 应用UI卡顿分析解决方法

分析UI卡顿我们一般都借助工具，通过工具一般都可以直观的分析出问题原因，从而反推寻求优化方案，具体如下细说各种强大的工具。

- 使用HierarchyViewer分析UI性能 

- 使用GPU过度绘制分析UI性能

- 使用GPU呈现模式图及FPS考核UI性能

- 使用Lint进行资源及冗余UI布局等优化

- 使用Memory监测及GC打印与Allocation Tracker进行UI卡顿分析 Android Monitor

- 使用Traceview和dmtracedump进行分析优化

-  使用Systrace进行分析优化

- 使用traces.txt文件进行ANR分析优化

