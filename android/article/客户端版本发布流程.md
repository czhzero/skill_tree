## Gezbox安卓客户端版本发布流程

### 预备知识

项目代码依赖种类比较多，目前分为三类。

![](http://o7y1sf21i.bkt.clouddn.com/blog/013/test3.png)

红色框线部分，代表依赖第三方代码，代码来源为jcenter或者mavenCentral
黄色框线部分，代表依赖自建服务器代码， 代码来源为http://10.0.1.249:8081/
蓝色框线部分，代表依赖本地项目模块代码， 这些都在setting.gradle有体现。

```
include ':app', ':tools', ':task', ':base', ':team', ':account'
include ':libraries:android-library-fengxin'
include ':libraries:android-library-map'

```

![](http://o7y1sf21i.bkt.clouddn.com/blog/013/test2.png)


注意，同一包名不能引用两次。例如，对于map包，不能够同时使用下面两种引用方式。

- 本地项目引用方式

```
compile project(':libraries:android-library-map')

```

- 自建服务器引用方式

```
  gezbox_map = 'com.gezbox.map:gezbox-map:1.0.0'
  compile config.gezbox_map
```


### Step1 更新所有代码到最新

更新develop分支到最新,

```
> cd 项目根目录
> git reset --hard 某个稳定版本的commit-id  #本步骤是防止冲突，不是必须步骤
> git pull
> git log   #检查更新情况

```

更新所有submodule到最新。

```
> cd 项目根目录
> git submodule foreach git checkout master #确保所有submodule都在master,不是必须步骤
> git submodule foreach git pull

```


### Step2 上传有更新的library到maven库, 并更新dependencies.gradle中依赖的版本号

- 确保library被include为本地项目，默认library没有include进来
- 根据需求，修改library中的代码。
- 修改gradle.properties文件中的`VERSION_NAME` ，进行+1操作
- 跳转到项目根目录执行如下命令

```
> ./gradlew :模块名:uploadArchives

```

- 到`http://10.0.1.249:8081/`服务器上面确认对应版本的library的aar文件是否已经上传成功
- 若上传成功，则修改dependencies.gradle中对应的版本号,修改为最新，然后sync gradle下载对应aar文件。
- sync完成后，检查`External Libraries`中是否已经包含最新版本的包。
- 上传library的改动代码到git服务器
- 把include中的引用去掉, 因为引用着也没啥用。


> 为了管理方便，每次发版本，都需要单独提交gradle.properties这个文件，然后作为一个单独的commit



### Step3 合入本地代码到develop

通过cherry-pick命令将本地修改代码合入develop，具体参考代码git操作文档。


### Step4 review代码

review代码，检查代码细节。

例如：

```
1. ProjectConstant.java 的 变量 是否为false
2. 是否有多余的临时代码。
3. 是否某些commit提交了多余的git submodule的引用文件。

```


### Step5 修改版本号，增加发布版本的commit的记录

打开config目录下的denpendencies.gradle文件

```
  //BasicInfo
  applicationId = "com.gezbox.winder.parttime"
  compileSdkVersion = 23
  buildToolsVersion = "23.0.1"
  minSdkVersion = 15
  targetSdkVersion = 23
  versionCode = 91
  versionName = "4.3.7"


```

增加versionCode数目，修改versionName。

verisionName，第一个数字为大版本号，第二个数字为中版本号，第三个数字为小版本号。
距离修改哪个版本号，视具体修改内容而定。


> 为了管理方便，每次发版本，都需要单独提交denpendencies.gradle这个文件，然后作为一个单独的commit
> 


发布版本的commit格式

```
feat-版本发布-23

```

### Step6 生成apk

输入以下命令

```
> ./gradlew assemble -Psuffix=V1

或者

> ./gradlew assembleRelease -Psuffix=V1

或者

> ./gradlew aR -Psuffix=V1

```

等待apk生成。

### Step7 上传apk到服务器

登录

[http://120.55.70.220:33497/](http://120.55.70.220:33497/)

上传你要发布的apk版本。写好文案，点击发布。

如果发布出错了，需要到七牛服务器删除上传的文件，同时需要联系服务端的同学，删除上传记录。

> 切记，别填错信息，包发错了，实在不行，加一个版本号，重新发一个版本，覆盖掉。


つづく...
